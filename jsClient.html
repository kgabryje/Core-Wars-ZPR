<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <title>Core Wars</title>

  <script src="gen-js/thrift.js"         type="text/javascript"></script>
  <script src="gen-js/mars_types.js"     type="text/javascript"></script>
  <script src="gen-js/MARS.js"           type="text/javascript"></script>

  <script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>


  <script type="text/javascript" charset="utf-8">
  var transport;
  var protocol;
  var client;
  var message;
  var gameInfo;
  var canvas;
  var canvasSize = 600;
  $(document).ready(function(){
     transport = new Thrift.TXHRTransport("http://localhost:9090");
     protocol  = new Thrift.TJSONProtocol(transport);
     client    = new MARS.MARSClient(protocol);

     gameInfo = new MARS.GameInfo();
     canvas = document.getElementById("gameTable");
     canvas.width = canvasSize;
     canvas.height = canvasSize;

     document.getElementById("display").style.display = 'none';
  });

  function waitForMessage() {
      message = client.sendMessage();
  }

  function displayPlayersInfo() {
    document.getElementById("firstPlayerInfo").innerHTML = 'Player 1 processes no.: ' + gameInfo.firstPlayerProcessesNumber;
    document.getElementById("secondPlayerInfo").innerHTML = 'Player 2 processes no.: ' + gameInfo.secondPlayerProcessesNumber;
  }

  function displaySimulation() {
    document.getElementById("presimulation").style.display = 'none';
    document.getElementById("display").style.display = "";
    while (1) {
      gameInfo = client.getGameInfo();
      if (!gameInfo.hasEnded) {
        displayPlayersInfo();
        drawTable();
      }
      else {
        alert(gameInfo.winner);
        break;
      }
    }
  }
  function sendCode() {
    var c = new MARS.Code();
    c.code = document.getElementById("code_text").value;
    c.playerName = document.getElementById("playerName").value;
    c.warriorName = document.getElementById("warriorName").value;
    if (c.code) {
      transport.open();
      client.receiveFromJS(c);
      waitForMessage();
      alert(message);
      transport.close();
    }
    if (message === "success") {
      displaySimulation();
    }
    document.getElementById("code_text").value = "";
    document.getElementById("playerName").value = "Player's Name";
    document.getElementById("warriorName").value = "Warrior's Name";
  }
  function drawTable() {
    var rect_size = 30;
    colors = ['blue', 'green', 'red', 'yellow', 'pink'];
    // var color_array  = new Array(Math.pow(canvasSize/rect_size, 2));
    color_array = gameInfo.colorTable;
    // for (var i = 0; i < color_array.length; i++) {
    //   color_array[i] = colors[Math.floor(Math.random()*colors.length)];
    // }

    var ctx = canvas.getContext("2d");
    for (var y = 0; y < Math.sqrt(color_array.length); y++) {
      for (var x = 0; x < Math.sqrt(color_array.length); x++) {
        ctx.fillStyle = color_array[y*Math.sqrt(color_array.length) + x];
        ctx.fillRect(rect_size * x, rect_size * y, rect_size, rect_size);
        ctx.strokeStyle = 'black';
        ctx.strokeRect(rect_size * x, rect_size * y, rect_size, rect_size);
      }
    }
  }
  </script>

</head>
<body>
  <h2>CoreWars</h2>
  <div id = "presimulation">
  <input id = "playerName" value="Player's name">
  <input id = "warriorName" value="Warrior's name">
  <div id = "code_area">
    <textarea id="code_text" value="" cols="80" rows="50"></textarea>
      <!-- <td><input type="textarea" cols="50" rows="20" id="code_text" value=""/></td> -->
    <tr>
      <td><input type="button" id="send_button" value="send code" onclick="sendCode();"/></td>
    </tr>
    <tr>
      <input type="file" id="files" name="files[]" multiple />
<output id="list"></output>

<script>
  function handleFileSelect(evt) {
    var files = evt.target.files; // FileList object

    var output = [];
    for (var i = 0, f; f = files[i]; i++) {
      var reader = new FileReader();
      reader.readAsText(f);
      output.push('<li><strong>', escape(f.name), '</strong> (', f.type || 'n/a', ') - ',
                  f.size, ' bytes, last modified: ',
                  f.lastModifiedDate ? f.lastModifiedDate.toLocaleDateString() : 'n/a',
                  '</li>');
      reader.onload = (function(theFile) {
        return function(e) {
          document.getElementById("code_text").value = reader.result;
          // Render thumbnail.

        };
      })(f);
    }
    document.getElementById('list').innerHTML = '<ul>' + output.join('') + '</ul>';
  }

  document.getElementById('files').addEventListener('change', handleFileSelect, false);
</script>
    </tr>
</div>
</div>
  <div id = "display">
    <p id = "firstPlayerInfo"></p>
    <p id = "secondPlayerInfo"></p>
    <canvas id="gameTable" width="" height="" style="border:1px solid #d3d3d3;">
  </canvas>
</div>
</body>
</html>
