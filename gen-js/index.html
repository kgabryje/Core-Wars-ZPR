<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <title>Core Wars</title>

  <script src="thrift.js"         type="text/javascript"></script>
  <script src="mars_types.js"     type="text/javascript"></script>
  <script src="MARS.js"           type="text/javascript"></script>

  <script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>


  <script type="text/javascript" charset="utf-8">
  var transport;
  var protocol;
  var client;
  var message;

  var canvas;
  var canvasSize = 600;
  $(document).ready(function(){
     transport = new Thrift.TXHRTransport("http://localhost:9090");
     protocol  = new Thrift.TJSONProtocol(transport);
     client    = new MARS.MARSClient(protocol);

     canvas = document.getElementById("gameTable");
     canvas.width = canvasSize;
     canvas.height = canvasSize;
  });

  function waitForMessage() {
      message = client.sendMessage();
  }
  function sendCode() {
      var c = new MARS.Code();
      c.code = document.getElementById("code_text").value;
      if (c.code) {
        transport.open();
        client.receiveFromJS(c);
        waitForMessage();
        alert(message);
        transport.close();
      }
  }
  function drawTable() {
    var rect_size = 30;
    colors = ['blue', 'green', 'red', 'yellow', 'pink'];
    // var color_array  = new Array(Math.pow(canvasSize/rect_size, 2));
    color_array = client.sendTable();
    for (var i = 0; i < color_array.length; i++) {
      color_array[i] = colors[Math.floor(Math.random()*colors.length)];
    }

    var ctx = canvas.getContext("2d");
    for (var y = 0; y < Math.sqrt(color_array.length); y++) {
      for (var x = 0; x < Math.sqrt(color_array.length); x++) {
        ctx.fillStyle = color_array[y*Math.sqrt(color_array.length) + x];
        ctx.fillRect(rect_size * x, rect_size * y, rect_size, rect_size);
        ctx.strokeStyle = 'black';
        ctx.strokeRect(rect_size * x, rect_size * y, rect_size, rect_size);
      }
    }
  }
  </script>

</head>
<body>
  <h2>Thrift test</h2>
  <textarea id="code_text" cols="50" rows="20"></textarea>
      <!-- <td><input type="textarea" cols="50" rows="20" id="code_text" value=""/></td> -->
    <tr>
      <td><input type="button" id="send_button" value="send code" onclick="sendCode();"/></td>
    </tr>
    <tr>
      <td><input type="button" id="draw_table" value="draw table" onclick="drawTable();"/></td>
    </tr>
    <canvas id="gameTable" width="" height="" style="border:1px solid #d3d3d3;">
  Your browser does not support the HTML5 canvas tag.</canvas>
</body>
</html>
